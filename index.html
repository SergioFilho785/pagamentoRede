<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Minha Home</title>
</head>
<body>
  <h1>Escolha seus produtos</h1>

  <div id="lista-produtos"></div>

  <br>
  <button id="btn-pagar">Pagar agora</button>

  <script>
    // Array de produtos
    const produtos = [
      { nome: "Camisa Preta", preco: 59.90 },
      { nome: "Boné Azul", preco: 39.50 },
      { nome: "Calça Jeans", preco: 120.00 },
      { nome: "Tênis Esportivo", preco: 199.90 },
      { nome: "Jaqueta", preco: 250.00 }
    ];

    const container = document.getElementById("lista-produtos");

    // Cria os produtos com quantidade inicial 0
    produtos.forEach((p, index) => {
      const div = document.createElement("div");
      div.innerHTML = `
        <span>${p.nome} - R$ ${p.preco.toFixed(2).replace(".", ",")}</span>
        <input type="number" class="quantidade" data-index="${index}" value="0" min="0" style="width:50px; margin-left:10px;">
      `;
      container.appendChild(div);
    });

    document.getElementById("btn-pagar").addEventListener("click", function () {
      // Coleta os produtos com quantidade > 0
      const produtosSelecionados = [];
      const inputs = document.querySelectorAll(".quantidade");

      inputs.forEach(input => {
        const qtd = parseInt(input.value) || 0;
        if (qtd > 0) {
          const index = input.dataset.index;
          produtosSelecionados.push({
            nome: produtos[index].nome,
            qtdd: qtd,
            preco: produtos[index].preco
          });
        }
      });

      if (produtosSelecionados.length === 0) {
        alert("Selecione a quantidade de pelo menos um produto!");
        return;
      }

      const dadosPagamento = {
        nome: "Sérgio",
        cartao: "credit",
        parcelas: 3,
        numeroCartao: "5448280000000007",
        mesVencimento: 12,
        anoVencimento: 28,
        cvv: "235"
      }

      // Monta o payload para enviar ao PHP
      const payload = {
        idUsuario: 1,
        produtos: produtosSelecionados,
        dadosPagamento: dadosPagamento
      };
    fetch("pagamentorede.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(response => response.text())    // ✔ TEM QUE SER text()
      .then(texto => {
        console.log("RESPOSTA BRUTA DO PHP:", texto);

        const data = JSON.parse(texto);     // ✔ Aqui convertimos manualmente

        if (data.redirect) {
          window.location.href = data.redirect;
        }

      })
      .catch(err => console.error(err));


    });
  </script>
</body>
</html>
